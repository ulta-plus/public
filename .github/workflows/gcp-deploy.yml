name: GCP Deploy

on:
  push:
    branches:
      - main

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
  # Add new directories in GitHub Actions Variables -> ALLOWED_DIRS
  # Each directory should have a corresponding GCP bucket with the same name
  ALLOWED_DIRS: ${{ vars.ALLOWED_DIRS }}
  DEPLOY_TYPE: ${{ vars.DEPLOY_TYPE }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 2

      - id: auth
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ env.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: ${{ env.PROJECT_ID }}

      - id: changed-files
        run: echo "files=$(git diff --name-only HEAD^ HEAD | tr '\n' ' ')" >> $GITHUB_OUTPUT

      - name: Deploy files
        run: |
          # Normalize ALLOWED_DIRS:
          # - supports comma or newline separated values
          # - trims whitespace
          # - removes leading/trailing slashes (e.g. "/naruzhu", "naruzhu/")
          ALLOWED_DIRS_RAW="${ALLOWED_DIRS:-}"
          ALLOWED_DIRS_RAW="${ALLOWED_DIRS_RAW//$'\n'/,}"
          IFS=',' read -ra __DIRS <<< "$ALLOWED_DIRS_RAW"
          ALLOWED_DIRS_CSV=""
          for dir in "${__DIRS[@]}"; do
            dir="$(echo "$dir" | tr -d '[:space:]')"
            dir="${dir#/}"
            dir="${dir%/}"
            # Only allow top-level directories (strip nested paths like "naruzhu/emai" -> "naruzhu")
            dir="${dir%%/*}"
            if [ -n "$dir" ]; then
              if [ -z "$ALLOWED_DIRS_CSV" ]; then
                ALLOWED_DIRS_CSV="$dir"
              else
                ALLOWED_DIRS_CSV="$ALLOWED_DIRS_CSV,$dir"
              fi
            fi
          done
          echo "Normalized ALLOWED_DIRS: ${ALLOWED_DIRS_CSV:-<empty (allow all)>}"

          if [ "$DEPLOY_TYPE" = "all" ]; then
            echo "Deploying all files from allowed directories"
            IFS=',' read -ra DIRS <<< "$ALLOWED_DIRS_CSV"
            if [ -z "$ALLOWED_DIRS_CSV" ]; then
              echo "ALLOWED_DIRS is empty, deploying all top-level directories"
              for dir in */; do
                [ -d "$dir" ] || continue
                dir="${dir%/}"
                echo "Deploying directory: $dir"
                gsutil rsync -r "$dir" "gs://${dir}/"
              done
            else
              for dir in "${DIRS[@]}"; do
                if [ -d "$dir" ]; then
                  echo "Deploying directory: $dir"
                  gsutil rsync -r "$dir" "gs://${dir}/"
                else
                  echo "Skipping missing directory: $dir"
                fi
              done
            fi
          else
            echo "Deploying only changed files"
            CHANGED_FILES="${{ steps.changed-files.outputs.files }}"
            if [ ! -z "$CHANGED_FILES" ]; then
              for file in $CHANGED_FILES; do
                if [ -f "$file" ]; then
                  # Определяем директорию первого уровня
                  TOP_DIR=$(echo "$file" | cut -d'/' -f1)
                  # Check if directory is in allowed list
                  if [[ -z "$ALLOWED_DIRS_CSV" || ",$ALLOWED_DIRS_CSV," == *",$TOP_DIR,"* ]]; then
                      BUCKET="${TOP_DIR}"
                      gsutil cp -r "$file" "gs://${BUCKET}/${file#*/}"
                      echo "Deployed: $file to gs://${BUCKET}/${file#*/}"
                  else
                      echo "Skipping file not in main project directories: $file"
                      continue
                  fi
                fi
              done
            else
              echo "No files changed"
            fi
          fi

      - name: Clean up
        if: always()
        run: gcloud auth revoke --all
